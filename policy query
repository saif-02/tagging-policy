Resources
| where type == "microsoft.policyinsights/compliances"
| extend complianceStatus = properties.complianceState
| where complianceStatus == "NonCompliant"
| extend tagDetails = properties.details[0].additionalProperties
| where tagDetails contains "tags"
| project resourceId, complianceStatus, policyAssignmentId, policyAssignmentName = properties.policyAssignmentName, missingTags = tagDetails["missingTags"], complianceTimestamp = properties.timestamp
| summarize nonCompliantCount = count() by policyAssignmentId, policyAssignmentName, complianceTimestamp
