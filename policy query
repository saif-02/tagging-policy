Resources
| where type == "microsoft.policyinsights/compliances"
| extend complianceStatus = properties.complianceState
| where complianceStatus == "NonCompliant"
| extend tagDetails = tostring(properties.details[0].additionalProperties)
| where tagDetails contains "tags"
| project resourceId = id, complianceStatus, policyAssignmentId = properties.policyAssignmentId, policyAssignmentName = properties.policyAssignmentName, missingTags = tagDetails
| summarize nonCompliantCount = count() by policyAssignmentId, policyAssignmentName
